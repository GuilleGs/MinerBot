// src/dialogs/level2/ProcedimientoDenunciasMenu.js
const { MessageFactory } = require('botbuilder');
const content = require('../data/content');

class ProcedimientoDenunciasMenu {
    constructor(bot) {
        this.bot = bot;
        this.options = [
            'Denuncia por Acoso',
            'Denuncia por Discriminaci√≥n',
            'Reporte de Conflicto de Inter√©s',
            'Realizar Denuncia An√≥nima' // ¬°NUEVA OPCI√ìN!
        ];
        this.returnOption = 'Volver';
    }

    async show(context) {
        const conversationData = await this.bot.conversationStateAccessor.get(context);
        // Si el bot est√° esperando el texto de la denuncia, NO mostramos el men√∫, solo el prompt del contenido
        if (conversationData.awaitingAnonymousComplaint) {
            await context.sendActivity(content['realizar denuncia an√≥nima ü§´']); // Muestra el mensaje introductorio
            return;
        }

        let menuText = 'üö® Procedimiento para Denuncias:\n';
        this.options.forEach((option, index) => {
            menuText += `${index + 1}. ${option}\n`;
        });
        menuText += `${this.options.length + 1}. ${this.returnOption}\n`;
        menuText += '\nPor favor, escribe el n√∫mero o el nombre de la opci√≥n.';

        await context.sendActivity(menuText);
    }

    async handleInput(context, text, conversationData, bot) {
        const lower = text.toLowerCase();
        const number = parseInt(text.trim());

        // --- INICIO CAMBIOS: L√≥gica para manejar el estado de espera de denuncia an√≥nima ---
        if (conversationData.awaitingAnonymousComplaint) {
            const complaintText = text.trim();
            if (!complaintText) {
                await context.sendActivity('Parece que no escribiste nada. Por favor, escribe tu denuncia o "volver" para cancelar.');
                return true;
            }
            if (lower === 'volver' || lower === 'cancelar') {
                conversationData.awaitingAnonymousComplaint = false;
                await context.sendActivity('Env√≠o de denuncia an√≥nima cancelado. Volviendo al men√∫ de Procedimiento para Denuncias.');
                await this.show(context);
                return true;
            }

            let success = false;
            try {
                console.log('ü§ñ DEBUG: Llamando a PowerAutomateService para denuncia an√≥nima desde ProcedimientoDenunciasMenu.');
                success = await this.bot.powerAutomateService.sendAnonymousComplaint(complaintText);
                console.log('ü§ñ DEBUG: sendAnonymousComplaint ha finalizado. √âxito:', success);
            } catch (error) {
                console.error('‚ùå ERROR INESPERADO en ProcedimientoDenunciasMenu al intentar enviar denuncia an√≥nima:', error);
                // No enviar mensaje al usuario aqu√≠, ya lo gestiona el finally o el PowerAutomateService
            } finally {
                if (success) {
                    await context.sendActivity('‚úÖ Tu denuncia an√≥nima ha sido enviada con √©xito. Agradecemos tu contribuci√≥n para mantener un ambiente de integridad.');
                } else {
                    await context.sendActivity('Hubo un problema al enviar tu denuncia an√≥nima. Por favor, intenta de nuevo m√°s tarde o contacta a un superior directamente.');
                }
                conversationData.awaitingAnonymousComplaint = false;
                conversationData.isInInfoDisplayState = false;
                await this.show(context); // Volver a mostrar el men√∫ de Procedimiento para Denuncias
                return true;
            }
        }
        // --- Fin de la l√≥gica para manejar el estado de espera de denuncia an√≥nima ---


        if (conversationData.isInInfoDisplayState && lower.includes(this.returnOption.toLowerCase())) {
            conversationData.isInInfoDisplayState = false;
            await this.show(context);
            return true;
        }

        if (!isNaN(number) && number > 0 && number <= this.options.length + 1) {
            const selectedOption = (number === this.options.length + 1) ? this.returnOption : this.options[number - 1];

            if (selectedOption.toLowerCase().includes(this.returnOption.toLowerCase())) {
                await bot.goBack(context, conversationData);
                return true;
            }

            // --- INICIO CAMBIOS: L√≥gica para 'Realizar Denuncia An√≥nima' ---
            if (selectedOption.toLowerCase().includes('realizar denuncia an√≥nima')) {
                conversationData.awaitingAnonymousComplaint = true; // Establecer el estado de espera
                await this.show(context); // Muestra el mensaje introductorio y espera la denuncia
                return true;
            }
            // --- FIN CAMBIOS ---

            const response = content[selectedOption.toLowerCase()];
            if (response) {
                await context.sendActivity(response);
            } else {
                await context.sendActivity(`Has seleccionado: "${text}" (No hay informaci√≥n detallada a√∫n).`);
            }
            conversationData.isInInfoDisplayState = true;
            return true;
        }
        else if (lower.includes(this.returnOption.toLowerCase())) {
            await bot.goBack(context, conversationData);
            return true;
        }
        // --- INICIO CAMBIOS: L√≥gica para 'Realizar Denuncia An√≥nima' por texto ---
        else if (lower.includes('realizar denuncia an√≥nima')) {
            conversationData.awaitingAnonymousComplaint = true; // Establecer el estado de espera
            await this.show(context); // Muestra el mensaje introductorio y espera la denuncia
            return true;
        }
        // --- FIN CAMBIOS ---

        const matchedOption = this.options.find(opt => opt.toLowerCase() === lower);
        if (matchedOption) {
            const response = content[lower];
            if (response) {
                await context.sendActivity(response);
            } else {
                await context.sendActivity(`Has seleccionado: "${text}" (No hay informaci√≥n detallada a√∫n).`);
            }
            conversationData.isInInfoDisplayState = true;
            return true;
        }

        return false;
    }
}

module.exports = ProcedimientoDenunciasMenu;