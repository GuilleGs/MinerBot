// src/bot/services/PowerAutomateService.js
const axios = require('axios');
const dotenv = require('dotenv');
dotenv.config();

class PowerAutomateService {
    constructor() {
        this.queryFlowUrl = process.env.POWER_AUTOMATE_QUERY_FLOW_URL;
        this.courseFlowUrl = process.env.POWER_AUTOMATE_COURSE_FLOW_URL;
        this.complaintFlowUrl = process.env.POWER_AUTOMATE_COMPLAINT_FLOW_URL; // ¬°A√ëADIDO!

        // Logs de depuraci√≥n para verificar URLs al inicio
        console.log('ü§ñ PowerAutomateService inicializado.');
        console.log('üîó QUERY_FLOW_URL:', this.queryFlowUrl ? 'CONFIGURADA' : 'NO CONFIGURADA');
        console.log('üîó COURSE_FLOW_URL:', this.courseFlowUrl ? 'CONFIGURADA' : 'NO CONFIGURADA');
        console.log('üîó COMPLAINT_FLOW_URL:', this.complaintFlowUrl ? 'CONFIGURADA' : 'NO CONFIGURADA'); // ¬°A√ëADIDO!
    }

    /**
     * Env√≠a una consulta no resuelta a un flujo de Power Automate.
     * @param {object} data - Objeto con los datos a enviar (nombreEmpleado, rutEmpleado, employeeArea, employeeCargo, consultaTexto).
     * @returns {Promise<boolean>} True si el env√≠o fue exitoso, false en caso contrario.
     */
    async sendUnresolvedQuery(data) {
        if (!this.queryFlowUrl) {
            console.error('‚ùå ERROR CR√çTICO: POWER_AUTOMATE_QUERY_FLOW_URL no est√° configurada en .env. No se puede enviar la consulta.');
            return false;
        }

        const now = new Date();
        const payload = {
            nombreEmpleado: data.nombreEmpleado || '',
            rutEmpleado: data.rutEmpleado || '',
            employeeArea: data.employeeArea || '',
            employeeCargo: data.employeeCargo || '',
            consultaTexto: data.consultaTexto || '',
            fecha: now.toLocaleDateString('es-CL', { timeZone: 'America/Santiago' }),
            hora: now.toLocaleTimeString('es-CL', { hourCycle: 'h23', timeZone: 'America/Santiago' })
        };

        try {
            const response = await axios.post(this.queryFlowUrl, payload);
            console.log('‚úÖ √âXITO: Consulta no resuelta enviada a Power Automate. Status:', response.status);
            return true;
        } catch (error) {
            console.error('‚ùå ERROR al enviar la consulta no resuelta a Power Automate:', error.message);
            if (error.response) console.error('    Detalles de la respuesta de Power Automate:', error.response.data);
            else if (error.request) console.error('    No se recibi√≥ respuesta del servidor de Power Automate (error de red/timeout).');
            else console.error('    Error de configuraci√≥n de la solicitud:', error.message);
            return false;
        }
    }

    /**
     * Env√≠a una solicitud de curso a un flujo de Power Automate.
     * @param {object} data - Objeto con los datos a enviar (nombreEmpleado, rutEmpleado, employeeArea, employeeCargo, cursoSolicitado).
     * @returns {Promise<boolean>} True si el env√≠o fue exitoso, false en caso contrario.
     */
    async sendCourseRequest(data) {
        if (!this.courseFlowUrl) {
            console.error('‚ùå ERROR CR√çTICO: POWER_AUTOMATE_COURSE_FLOW_URL no est√° configurada en .env. No se puede enviar la solicitud de curso.');
            return false;
        }

        const now = new Date();
        const payload = {
            nombreEmpleado: data.nombreEmpleado || '',
            rutEmpleado: data.rutEmpleado || '',
            employeeArea: data.employeeArea || '',
            employeeCargo: data.employeeCargo || '',
            cursoSolicitado: data.cursoSolicitado || '',
            fechaSolicitud: now.toLocaleDateString('es-CL', { timeZone: 'America/Santiago' }),
            horaSolicitud: now.toLocaleTimeString('es-CL', { hourCycle: 'h23', timeZone: 'America/Santiago' })
        };

        try {
            const response = await axios.post(this.courseFlowUrl, payload);
            console.log('‚úÖ √âXITO: Solicitud de curso enviada a Power Automate. Status:', response.status);
            return true;
        } catch (error) {
            console.error('‚ùå ERROR al enviar la solicitud de curso a Power Automate:', error.message);
            if (error.response) console.error('    Detalles de la respuesta de Power Automate:', error.response.data);
            else if (error.request) console.error('    No se recibi√≥ respuesta del servidor de Power Automate (error de red/timeout).');
            else console.error('    Error de configuraci√≥n de la solicitud:', error.message);
            return false;
        }
    }

    /**
     * Env√≠a una denuncia an√≥nima a un flujo de Power Automate.
     * No incluye datos de empleado para preservar el anonimato.
     * @param {string} complaintText - El texto de la denuncia.
     * @returns {Promise<boolean>} True si el env√≠o fue exitoso, false en caso contrario.
     */
    async sendAnonymousComplaint(complaintText) { // ¬°NUEVO M√âTODO A√ëADIDO!
        if (!this.complaintFlowUrl) {
            console.error('‚ùå ERROR CR√çTICO: POWER_AUTOMATE_COMPLAINT_FLOW_URL no est√° configurada en .env. No se puede enviar la denuncia an√≥nima.');
            return false;
        }

        console.log('ü§ñ DEBUG: Iniciando env√≠o de denuncia an√≥nima a Power Automate.');
        console.log('ü§ñ DEBUG: URL del flujo de denuncia an√≥nima a usar:', this.complaintFlowUrl);

        const now = new Date();
        const payload = {
            textoDenuncia: complaintText || '',
            fecha: now.toLocaleDateString('es-CL', { timeZone: 'America/Santiago' }),
            hora: now.toLocaleTimeString('es-CL', { hourCycle: 'h23', timeZone: 'America/Santiago' })
        };
        console.log('ü§ñ DEBUG: Payload para denuncia an√≥nima:', JSON.stringify(payload));

        try {
            const response = await axios.post(this.complaintFlowUrl, payload);
            console.log('‚úÖ √âXITO: Denuncia an√≥nima enviada a Power Automate. Status:', response.status);
            return true;
        } catch (error) {
            console.error('‚ùå ERROR al enviar la denuncia an√≥nima a Power Automate:', error.message);
            if (error.response) console.error('    Detalles de la respuesta de Power Automate:', error.response.data);
            else if (error.request) console.error('    No se recibi√≥ respuesta del servidor de Power Automate (error de red/timeout).');
            else console.error('    Error de configuraci√≥n de la solicitud:', error.message);
            return false;
        }
    }
}

module.exports = PowerAutomateService;